defmodule Library.Repo.Migrations.AddAuditTrailTableViewForCatalog do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    execute """
    CREATE OR REPLACE VIEW catalog_versions_view AS
    SELECT
      'catalog_book' AS entity_type,
      id,
      version_action_type,
      version_action_name,
      version_source_id,
      changes,
      version_inserted_at,
      version_updated_at
    FROM
      catalog_books_versions

    UNION ALL

    SELECT
      'catalog_author' AS entity_type,
      id,
      version_action_type,
      version_action_name,
      version_source_id,
      changes,
      version_inserted_at,
      version_updated_at
    FROM
      catalog_authors_versions

    UNION ALL

    SELECT
      'catalog_books_author' AS entity_type,
      id,
      version_action_type,
      version_action_name,
      version_source_id,
      changes,
      version_inserted_at,
      version_updated_at
    FROM
      catalog_books_authors_versions
    ;
    """
  end

  def down do
    execute "DROP VIEW catalog_versions_view"
  end
end
